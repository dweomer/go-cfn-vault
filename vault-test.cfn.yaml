AWSTemplateFormatVersion: '2010-09-09'
Description: Auto-scaling, auto-initializing, HA Vault


Metadata: #####################################################################
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Network and Endpoint Configuration
        Parameters:
          - RemoteAccessCidrBlock
          - PlatformNumber
          - AvailabilityZones
          - InternalDomain
      - Label:
          default: Vault Configuration
        Parameters:
          - VaultScheme
          - VaultInternalName
          - VaultPort
          - VaultImage
          - VaultDockerEngine
          - VaultKeyPair
          - VaultStorageMaxParallel
          - VaultStorageReadCapacity
          - VaultStorageWriteCapacity
          - VaultAutoscalingTimeoutInMinutes
          - VaultRootTokenParameterSuffix
          - VaultSecretShareParameterSuffix
          - VaultTransitTokenParameterSuffix
          - VaultTransitKeyName
          - VaultCertificateArn
          - VaultPkiBucket
          - VaultPackageBucket
    ParameterLabels:
      RemoteAccessCidrBlock:
        default: 'Remote Access Address Range'
      PlatformNumber:
        default: 'Platform Number'
      AvailabilityZones:
        default: 'Availability Zones'
      InternalDomain:
        default: 'Private Domain Name'
      VaultScheme:
        default: 'Service URL Scheme'
      VaultInternalName:
        default: 'Service Name'
      VaultPort:
        default: 'Service Port'
      VaultDockerEngine:
        default: 'Docker Engine'
      VaultImage:
        default: 'Docker Image'
      VaultKeyPair:
        default: 'SSH Key'
      VaultStorageMaxParallel:
        default: 'Storage: max concurrent requests'
      VaultStorageReadCapacity:
        default: 'Storage: max reads per second'
      VaultStorageWriteCapacity:
        default: 'Storage: max writes per second'
      VaultAutoscalingTimeoutInMinutes:
        default: 'Autoscaling Timeout'
      VaultRootTokenParameterSuffix:
        default: 'Root Token Parameter Suffix'
      VaultSecretShareParameterSuffix:
        default: 'Secret Share Parameter Suffix'
      VaultTransitTokenParameterSuffix:
        default: 'Transit Token Parameter Suffix'
      VaultTransitKeyName:
        default: 'Transit Managed Encryption Key'
      VaultCertificateArn:
        default: 'Vault Service Certificate ARN in ACM or IAM'
      VaultPkiBucket:
        default: 'PKI Private Bucket'
      VaultPackageBucket:
        default: 'Vault Custom Resource(s) Code Bucket'
# Metadata ####################################################################


Parameters: ###################################################################
  RemoteAccessCidrBlock:
    Type: String
    Default: 0.0.0.0/0

  PlatformNumber:
    Description: >-
      The second octet of your new VPC /16 network. These should be unique
      across all platforms. Non-unique platforms will not be routable from
      common infrastructure.
    Type: String
    MaxLength: '3'
    MinLength: '2'
    AllowedPattern: '^[1-9][0-9]$|^1[0-9][0-9]$|2[0-4][0-9]$|^25[0-5]$'
    Default: 69

  AvailabilityZones:
    Description: >-
      List of availability zones available on the account in the target region.
      Requires 3.
    Type: List<AWS::EC2::AvailabilityZone::Name>

  InternalDomain:
    Description: The internal/private domain.
    Type: String
    Default: internal

  VaultScheme:
    Description: HTTP or HTTPS?
    Type: String
    Default: 'https'
    AllowedValues:
      - http
      - https

  VaultInternalName:
    Description: The host short name (aka minus domain suffix).
    Type: String
    Default: 'vault'

  VaultPort:
    Description: The port to send vault api requests to.
    Type: String
    Default: '8200'

  VaultDockerEngine:
    Type: String
    Description: 'Docker Engine to use for Vault instances. See https://github.com/rancher/os-services/tree/master/d'
    Default: 'docker-17.06.2-ce'

  VaultImage:
    Type: String
    Description: 'The Vault docker image version to use. Check latest here: https://hub.docker.com/_/vault/'
    Default: 'vault:0.9.1'

  VaultKeyPair:
    Description: The name of the EC2 keypair to install on each vault node.
    Type: AWS::EC2::KeyPair::KeyName

  VaultStorageMaxParallel:
    Type: String
    Description: 'https://www.vaultproject.io/docs/configuration/storage/dynamodb.html#max_parallel'
    Default: 128
    AllowedPattern: ^[0-9]*$

  VaultStorageReadCapacity:
    Type: String
    Description: 'https://www.vaultproject.io/docs/configuration/storage/dynamodb.html#read_capacity'
    Default: 5
    AllowedPattern: ^[0-9]*$

  VaultStorageWriteCapacity:
    Type: String
    Description: 'https://www.vaultproject.io/docs/configuration/storage/dynamodb.html#write_capacity'
    Default: 5
    AllowedPattern: ^[0-9]*$

  VaultAutoscalingTimeoutInMinutes:
    Type: String
    Description: Number of minutes to wait for all autoscaling instances to report in during create/update
    Default: '10'
    AllowedValues:
      - '1'
      - '2'
      - '3'
      - '4'
      - '5'
      - '6'
      - '7'
      - '8'
      - '9'
      - '10'

  VaultSecretShareParameterSuffix:
    Type: String
    Description: Vault Secret Share Parameter Suffix
    Default: 'Vault/Secret/Unseal'

  VaultRootTokenParameterSuffix:
    Type: String
    Description: Vault Root Token Parameter Suffix
    Default: 'Vault/Token/Root'

  VaultTransitTokenParameterSuffix:
    Type: String
    Description: Vault Transit Token Parameter Suffix
    Default: 'Vault/Token/Transit'

  VaultTransitKeyName:
    Type: String
    Description: Vault Transit Managed Key
    Default: 'default'

  VaultCertificateArn:
    Type: String
    Description: Vault Service Certificate ARN in ACM or IAM

  VaultPkiBucket:
    Description: The Bucket Name that houses our service private keys, certificates, and CA bundle(s).
    Type: String

  VaultPackageBucket:
    Description: Custom Resource(s) Code Bucket
    Type: String
# Parameters ##################################################################


Outputs: ######################################################################
  VaultVpcId:
    Value: !Ref Vpc

  VaultVpcCidrBlock:
    Value: !GetAtt Vpc.CidrBlock

  VaultURL:
    Description: The Vault URL
    Value: !Sub '${VaultScheme}://${VaultInternalName}.${InternalDomain}:${VaultPort}'

  VaultInternalLoadBalancerDnsName:
    Description: The FQDN of the internal Vault load-balancer
    Value: !GetAtt
      - VaultInternalLoadBalancer
      - DNSName

  VaultRootTokenParameter:
    Description: Parameter name of the Vault Root Token
    Value: !GetAtt VaultInitialization.RootTokenParameterName

  VaultSecretShareParameter:
    Description: Parameter name of the Vault Unseal Key
    Value: !GetAtt VaultInitialization.SecretShareParameterName

  VaultTransitTokenParameter:
    Description: Parameter name of the Vault Transit Token
    Value: !GetAtt VaultTransitToken.ParameterName
# Outputs #####################################################################


Conditions: ###################################################################
  VaultUseTLS: !Equals [!Ref VaultScheme, https]
# Conditions ##################################################################


Mappings: #####################################################################

  RegionalConfig:
  # RancherAMI: https://github.com/rancher/os#amazon
  # ELBAccountId: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html#access-logging-bucket-permissions
    us-east-1:
      RancherAMI: ami-4584ec3f
      ELBAccountId: '127311923021'
    us-east-2:
      RancherAMI: ami-4695bc23
      ELBAccountId: '033677994240'
    us-west-1:
      RancherAMI: ami-d24e4ab2
      ELBAccountId: '027434742980'
    us-west-2:
      RancherAMI: ami-99cb6de1
      ELBAccountId: '797873946194'
    ca-central-1:
      RancherAMI: ami-1cdd6778
      ELBAccountId: '985666609251'
    eu-central-1:
      RancherAMI: ami-b632bad9
      ELBAccountId: '054676820928'
    eu-west-1:
      RancherAMI: ami-c5b134bc
      ELBAccountId: '156460612806'
    eu-west-2:
      RancherAMI: ami-82a5bbe6
      ELBAccountId: '652711504416'
    ap-northeast-1:
      RancherAMI: ami-ece6648a
      ELBAccountId: '582318560864'
    ap-northeast-2:
      RancherAMI: ami-6c54f202
      ELBAccountId: '600734575887'
    ap-southeast-1:
      RancherAMI: ami-f4e58488
      ELBAccountId: '114774131450'
    ap-southeast-2:
      RancherAMI: ami-1544b377
      ELBAccountId: '783225319266'
    ap-south-1:
      RancherAMI: ami-97ade5f8
      ELBAccountId: '718504428378'
    sa-east-1:
      RancherAMI: ami-0750166b
      ELBAccountId: '507241528517'

  MinutesToISO8601Duration:
    '1':
      Duration: PT1M
    '2':
      Duration: PT2M
    '3':
      Duration: PT3M
    '4':
      Duration: PT4M
    '5':
      Duration: PT5M
    '6':
      Duration: PT6M
    '7':
      Duration: PT7M
    '8':
      Duration: PT8M
    '9':
      Duration: PT9M
    '10':
      Duration: PT10M
    '11':
      Duration: PT11M
    '12':
      Duration: PT12M
    '13':
      Duration: PT13M
    '14':
      Duration: PT14M
    '15':
      Duration: PT15M
# Mappings ####################################################################


Resources: ####################################################################
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      EnableDnsHostnames: 'true'
      EnableDnsSupport: 'true'
      CidrBlock: !Sub '10.${PlatformNumber}.0.0/16'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-VPC'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  InternalZone:
    Type: AWS::Route53::HostedZone
    Properties:
      HostedZoneConfig:
        Comment: !Sub '${AWS::StackName} ${InternalDomain}'
      Name: !Ref InternalDomain
      VPCs:
        - VPCId: !Ref Vpc
          VPCRegion: !Ref 'AWS::Region'
      HostedZoneTags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-InternalZone'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  InternetGateway:
    DependsOn: Vpc
    Type: AWS::EC2::InternetGateway
    DependsOn:
      - Vpc
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-IG'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  GatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    DependsOn:
      - InternetGateway
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway

  NatGateway1:
    Type: AWS::EC2::NatGateway
    DependsOn:
      - NatGateway1Eip
      - PublicAssociation1
    Properties:
      AllocationId: !GetAtt 
        - NatGateway1Eip
        - AllocationId
      SubnetId: !Ref PublicSubnet1

  NatGateway1Eip:
    Type: AWS::EC2::EIP
    DependsOn:
      - GatewayAttachment
    Properties:
      Domain: vpc

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    DependsOn:
      - GatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-RoutesForPublic'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    DependsOn:
      - GatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Join 
            - '-'
            - - !Sub '${AWS::StackName}-RoutesForPrivate'
              - !Select
                - '0'
                - !Ref AvailabilityZones
              - !Select 
                - '1'
                - !Ref AvailabilityZones
              - !Select 
                - '2'
                - !Ref AvailabilityZones
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  RouteToInternetFromPublic:
    Type: AWS::EC2::Route
    DependsOn:
      - GatewayAttachment
      - PublicRouteTable
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref PublicRouteTable

  RouteToInternetViaNatFromPrivate1:
    Type: AWS::EC2::Route
    DependsOn:
      - NatGateway1
      - PrivateRouteTable1
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1
      RouteTableId: !Ref PrivateRouteTable1

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select 
        - '0'
        - !Ref AvailabilityZones
      CidrBlock: !Sub '10.${PlatformNumber}.64.0/20'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-PrivateSubnet1'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: PeerRange
          Value: !Sub '10.${PlatformNumber}.64.0 through 10.${PlatformNumber}.159.255'
        - Key: CIDR
          Value: !Sub '10.${PlatformNumber}.64.0/20'
        - Key: AvailabilityZone
          Value: !Select 
            - '0'
            - !Ref AvailabilityZones
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select 
        - '1'
        - !Ref AvailabilityZones
      CidrBlock: !Sub '10.${PlatformNumber}.80.0/20'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-PrivateSubnet2'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: PeerRange
          Value: !Sub '10.${PlatformNumber}.64.0 through 10.${PlatformNumber}.159.255'
        - Key: CIDR
          Value: !Sub '10.${PlatformNumber}.80.0/20'
        - Key: AvailabilityZone
          Value: !Select 
            - '1'
            - !Ref AvailabilityZones
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select 
        - '2'
        - !Ref AvailabilityZones
      CidrBlock: !Sub '10.${PlatformNumber}.96.0/20'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-PrivateSubnet3'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: PeerRange
          Value: !Sub '10.${PlatformNumber}.64.0 through 10.${PlatformNumber}.159.255'
        - Key: CIDR
          Value: !Sub '10.${PlatformNumber}.96.0/20'
        - Key: AvailabilityZone
          Value: !Select 
            - '2'
            - !Ref AvailabilityZones
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  PrivateAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
      - PrivateRouteTable1
      - PrivateSubnet1
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
      - PrivateRouteTable1
      - PrivateSubnet2
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet2

  PrivateAssociation3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
      - PrivateRouteTable1
      - PrivateSubnet3
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet3

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select 
        - '0'
        - !Ref AvailabilityZones
      CidrBlock: !Sub '10.${PlatformNumber}.160.0/20'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-PublicSubnet1'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: PeerRange
          Value: !Sub '10.${PlatformNumber}.160.0 through 10.${PlatformNumber}.255.255'
        - Key: CIDR
          Value: !Sub '10.${PlatformNumber}.160.0/20'
        - Key: AvailabilityZone
          Value: !Select 
            - '0'
            - !Ref AvailabilityZones
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select 
        - '1'
        - !Ref AvailabilityZones
      CidrBlock: !Sub '10.${PlatformNumber}.176.0/20'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-PublicSubnet2'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: PeerRange
          Value: !Sub '10.${PlatformNumber}.160.0 through 10.${PlatformNumber}.255.255'
        - Key: CIDR
          Value: !Sub '10.${PlatformNumber}.176.0/20'
        - Key: AvailabilityZone
          Value: !Select 
            - '1'
            - !Ref AvailabilityZones
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select 
        - '2'
        - !Ref AvailabilityZones
      CidrBlock: !Sub '10.${PlatformNumber}.192.0/20'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-PublicSubnet3'
        - Key: Network
          Value: !Sub '10.${PlatformNumber}.0.0/16'
        - Key: PeerRange
          Value: !Sub '10.${PlatformNumber}.160.0 through 10.${PlatformNumber}.255.255'
        - Key: CIDR
          Value: !Sub '10.${PlatformNumber}.192.0/20'
        - Key: AvailabilityZone
          Value: !Select 
            - '2'
            - !Ref AvailabilityZones
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  PublicAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
      - PublicRouteTable
      - PublicSubnet1
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
      - PublicRouteTable
      - PublicSubnet2
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PublicAssociation3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
      - PublicRouteTable
      - PublicSubnet3
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet3

  VaultInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRole
            Principal:
              Service:
                - !Sub 'ec2.${AWS::URLSuffix}'

  VaultInstancePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:Query
              - dynamodb:QueryPages
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:BatchWriteItem
            Resource: !GetAtt VaultStorageTable.Arn
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
              - logs:DescribeLogStreams
            Resource: !GetAtt 'VaultAuditLogGroup.Arn'
          - Effect: Allow
            Action:
              - cloudwatch:PutMetricData
              - cloudwatch:GetMetricStatistics
              - cloudwatch:ListMetrics
            Resource:
              - '*'
          - Effect: Allow
            Action:
              - s3:Get*
              - s3:List*
              - s3:Head*
            Resource: !Sub 'arn:aws:s3:::${VaultPkiBucket}/*'
      PolicyName: !Ref VaultInstanceRole
      Roles:
        - !Ref VaultInstanceRole

  VaultInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    DependsOn:
      - VaultInstanceRole
    Properties:
      Path: /
      Roles:
        - !Ref VaultInstanceRole

  VaultRemoteAccessGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enables remote access from DevOps VPC
      VpcId: !Ref Vpc
      SecurityGroupEgress:
        # Allows Rancher OS to pull vault image
        - CidrIp: 0.0.0.0/0
          FromPort: '80'
          ToPort: '80'
          IpProtocol: tcp
        # Allows Rancher OS to pull vault image
        - CidrIp: 0.0.0.0/0
          FromPort: '443'
          ToPort: '443'
          IpProtocol: tcp
      SecurityGroupIngress:
        # Allows communication between the Vault Servers and the Private LB
        - SourceSecurityGroupId: !Ref VaultInternalLoadBalancerGroup
          IpProtocol: tcp
          FromPort: !Ref VaultPort
          ToPort: !Ref VaultPort
        - CidrIp: !Ref RemoteAccessCidrBlock
          IpProtocol: tcp
          FromPort: !Ref VaultPort
          ToPort: !Ref VaultPort
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-VaultRemoteAccessGroup'
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  VaultInternalLoadBalancerGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref Vpc
      GroupDescription: Internal ELB instances attached only to a private subnet.
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-VaultInternalLoadBalancerGroup'
        - Key: Environment
          Value: !Ref 'AWS::StackName'

  # Allows outbound communication to Vault Servers
  VaultInternalLoadBalancerGroupEgress:
    Type: AWS::EC2::SecurityGroupEgress
    DependsOn:
      - VaultInternalLoadBalancerGroup
    Properties:
      GroupId: !Ref VaultInternalLoadBalancerGroup
      DestinationSecurityGroupId: !Ref VaultRemoteAccessGroup
      IpProtocol: tcp
      FromPort: '1024'
      ToPort: '65535'

  # Allows communication from Rancher servers
  VaultInternalLoadBalancerGroupIngress1:
    Type: AWS::EC2::SecurityGroupIngress
    DependsOn:
      - VaultInternalLoadBalancerGroup
    Properties:
      GroupId: !Ref VaultInternalLoadBalancerGroup
      CidrIp: !GetAtt Vpc.CidrBlock
      FromPort: !Ref VaultPort
      ToPort: !Ref VaultPort
      IpProtocol: tcp

  # Allows communication from the remote access control plane
  VaultInternalLoadBalancerGroupIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    DependsOn:
      - VaultInternalLoadBalancerGroup
    Properties:
      GroupId: !Ref VaultInternalLoadBalancerGroup
      CidrIp: !Ref RemoteAccessCidrBlock
      FromPort: !Ref VaultPort
      ToPort: !Ref VaultPort
      IpProtocol: tcp

  VaultInternalTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /v1/sys/health
      HealthCheckProtocol: !If [VaultUseTLS, HTTPS, HTTP]
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      Port: !Ref VaultPort
      Protocol: !If [VaultUseTLS, HTTPS, HTTP]
      VpcId: !Ref Vpc

  VaultInternalLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DependsOn:
      - VaultInternalLoadBalancerGroup
    Properties:
      Scheme: internal
      SecurityGroups:
        - !Ref VaultInternalLoadBalancerGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3

  VaultInternalListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    DependsOn:
      - VaultInternalLoadBalancer
      - VaultInternalLoadBalancerGroup
      - VaultInternalTargetGroup
    Properties:
      LoadBalancerArn: !Ref VaultInternalLoadBalancer
      Port: !Ref VaultPort
      Protocol: !If [VaultUseTLS, HTTPS, HTTP]
      SslPolicy: !If [VaultUseTLS, 'ELBSecurityPolicy-TLS-1-2-2017-01', !Ref 'AWS::NoValue'] 
      Certificates:
        Fn::If:
          - VaultUseTLS
          - [CertificateArn: !Ref VaultCertificateArn]
          - !Ref 'AWS::NoValue'
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref VaultInternalTargetGroup

    VaultInternalLoadBalancerAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      Namespace: AWS/ApplicationELB
      AlarmDescription: Alarm to monitor if the Vault ALB instance count drops below 1
      ComparisonOperator: LessThanThreshold
      Threshold: '1'
      EvaluationPeriods: '1'
      Period: '60'
      MetricName: HealthyHostCount
      Statistic: Average
      AlarmActions:
        - !Ref 'VaultMonitoringTopic'
      Dimensions:
        - Name: TargetGroup
          Value: !GetAtt VaultInternalTargetGroup.TargetGroupFullName
        - Name: LoadBalancer
          Value: !GetAtt VaultInternalLoadBalancer.LoadBalancerFullName

VaultInternalAlias:
    Type: AWS::Route53::RecordSetGroup
    DependsOn:
      - VaultInternalLoadBalancer
      - VaultInternalLoadBalancerGroupIngress1
    Properties:
      HostedZoneId: !Ref InternalZone
      Comment: Vault alias targeted to VaultInternalLoadBalancer.
      RecordSets:
      - Name: !Sub '${VaultInternalName}.${InternalDomain}.'
        Type: A
        AliasTarget:
          HostedZoneId: !GetAtt
            - VaultInternalLoadBalancer
            - CanonicalHostedZoneID
          DNSName: !GetAtt
            - VaultInternalLoadBalancer
            - DNSName

  VaultStorageTopic:
    Type: AWS::SNS::Topic

  VaultStorageTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: 'Path'
          AttributeType: 'S'
        - AttributeName: 'Key'
          AttributeType: 'S'
      KeySchema:
        - AttributeName: 'Path'
          KeyType: 'HASH'
        - AttributeName: 'Key'
          KeyType: 'RANGE'
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref VaultStorageReadCapacity
        WriteCapacityUnits: !Ref VaultStorageWriteCapacity

  VaultStorageThrottledRequestsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Sum of throttled read and write requests is over 1/min.
      Namespace: AWS/DynamoDB
      MetricName: ThrottledRequests
      Unit: Count
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 5
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref VaultStorageTable
      AlarmActions:
        - !Ref VaultStorageTopic
      InsufficientDataActions:
        - !Ref VaultStorageTopic

  VaultStorageSystemErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Sum of 500 system errors is over 1/min.
      Namespace: AWS/DynamoDB
      MetricName: SystemErrors
      Unit: Count
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 5
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref VaultStorageTable
      AlarmActions:
        - !Ref VaultStorageTopic
      InsufficientDataActions:
        - !Ref VaultStorageTopic

  VaultLaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    DependsOn:
      - VaultAuditLogGroup
      - VaultInstancePolicy
    Properties:
      ImageId: !FindInMap [RegionalConfig, !Ref 'AWS::Region', RancherAMI]
      InstanceType: t2.medium
      SecurityGroups:
        - !Ref VaultRemoteAccessGroup
        - !GetAtt Vpc.DefaultSecurityGroup
      KeyName: !Ref VaultKeyPair
      InstanceMonitoring: true
      IamInstanceProfile: !Ref VaultInstanceProfile
      EbsOptimized: false
      UserData:
        Fn::Base64:
          !Sub |
            #cloud-config
            write_files:
              - path: /opt/vault/config/vault.hcl
                permissions: "0644"
                content: |
                  storage "dynamodb" {
                    region = "${AWS::Region}"
                    table = "${VaultStorageTable}"
                    ha_enabled = "true"
                    max_parallel = "${VaultStorageMaxParallel}"
                    read_capacity = "${VaultStorageReadCapacity}"
                    write_capacity = "${VaultStorageWriteCapacity}"
                  }

                  listener "tcp" {
                    address = "0.0.0.0:${VaultPort}"

                    tls_disable = 0
                    tls_cert_file = "/vault/config/tls/certificate.pem"
                    tls_key_file = "/vault/config/tls/private-key.pem"
                    tls_min_version = "tls12"
                    tls_prefer_server_cipher_suites = "true"
                  }
              - path: /opt/vault/awslogs.conf
                permissions: "0644"
                content: |
                  [general]
                  state_file = /var/awslogs/state/agent-state

                  [/vault/logs/audit.log]
                  file = /vault/logs/audit.log
                  log_group_name = ${VaultAuditLogGroup}
                  log_stream_name = {instance_id}
                  datetime_format = %Y-%m-%dT%H:%M:%S.%f
            runcmd:
              - mkdir -p /opt/vault/logs
              - chmod 775 /opt/vault/logs
              - ros config set rancher.environment.AWS_INSTANCE_ID $(wget -qO- http://169.254.169.254/latest/meta-data/instance-id)
              - ros config set rancher.environment.AWS_LOCAL_IPV4 $(wget -qO- http://169.254.169.254/latest/meta-data/local-ipv4)
            rancher:
              docker:
                engine: !Ref VaultDockerEngine
              services:
                vault-tls-certificate:
                  image: dweomer/awscli
                  command: s3 cp s3://${VaultPkiBucket}/${VaultInternalName}.${InternalDomain}-certificate.pem /vault/config/tls/certificate.pem
                  labels:
                    io.rancher.os.after: network
                    io.rancher.os.before: docker
                    io.rancher.os.scope: system
                  volumes:
                    - /opt/vault/config:/vault/config
                vault-tls-private-key:
                  image: dweomer/awscli
                  command: s3 cp s3://${VaultPkiBucket}/${VaultInternalName}.${InternalDomain}-private-key.pem /vault/config/tls/private-key.pem
                  labels:
                    io.rancher.os.after: network
                    io.rancher.os.before: docker
                    io.rancher.os.scope: system
                  volumes:
                    - /opt/vault/config:/vault/config
                vault:
                  image: ${VaultImage}
                  hostname: ${VaultInternalName}.${InternalDomain}
                  restart: unless-stopped
                  environment:
                    - VAULT_ADDR=${VaultScheme}://127.0.0.1:${VaultPort}
                    - VAULT_REDIRECT_ADDR=${VaultScheme}://${VaultInternalName}.${InternalDomain}:${VaultPort}
                    - VAULT_TLS_SERVER_NAME=${VaultInternalName}.${InternalDomain}
                  cap_add:
                    - IPC_LOCK
                  ports:
                    - "${VaultPort}:${VaultPort}"
                  volumes:
                    - /opt/vault/config:/vault/config
                    - /opt/vault/logs:/vault/logs
                  command: server
                vault-audit-logs:
                  image: ernestoojeda/awslogs
                  restart: unless-stopped
                  environment:
                    - REGION=${AWS::Region}
                  volumes:
                    - /opt/vault/awslogs.conf:/awslogs.conf
                    - /opt/vault/logs:/vault/logs
                vault-signal-asg:
                  image: dweomer/awscfn
                  command: cfn-signal --success true --region ${AWS::Region} --stack ${AWS::StackName} --resource VaultAutoscalingGroup
                  depends_on:
                    - vault
                  restart: on-failure

  VaultMonitoringTopic:
    Type: AWS::SNS::Topic

  VaultAutoscalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn:
      - RouteToInternetViaNatFromPrivate1
      - RouteToInternetFromPublic
      - VaultInternalAlias
    CreationPolicy:
      AutoScalingCreationPolicy:
        MinSuccessfulInstancesPercent: 100
      ResourceSignal:
        Count: 2
        Timeout: !FindInMap [MinutesToISO8601Duration, !Ref 'VaultAutoscalingTimeoutInMinutes', Duration]
    UpdatePolicy:
      AutoScalingReplacingUpdate:
        WillReplace: true
      AutoScalingRollingUpdate:
        MaxBatchSize: 1
        MinInstancesInService: 1
        MinSuccessfulInstancesPercent: 100
        PauseTime: !FindInMap [MinutesToISO8601Duration, !Ref 'VaultAutoscalingTimeoutInMinutes', Duration]
        WaitOnResourceSignals: true
    Properties:
      DesiredCapacity: 2
      MaxSize: 2
      MinSize: 2
      TargetGroupARNs:
        - !Ref VaultInternalTargetGroup
      HealthCheckGracePeriod: 300
      HealthCheckType: EC2
      LaunchConfigurationName: !Ref VaultLaunchConfiguration
      MetricsCollection:
        - Granularity: 1Minute
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      NotificationConfigurations:
        - TopicARN: !Ref VaultMonitoringTopic
          NotificationTypes:
            - autoscaling:EC2_INSTANCE_LAUNCH
            - autoscaling:EC2_INSTANCE_LAUNCH_ERROR
            - autoscaling:EC2_INSTANCE_TERMINATE
            - autoscaling:EC2_INSTANCE_TERMINATE_ERROR
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-VaultServer'
          PropagateAtLaunch: 'true'
        - Key: Environment
          Value: !Ref 'AWS::StackName'
          PropagateAtLaunch: 'true'

  VaultRootTokenEncryptionAlias:
    Type: AWS::KMS::Alias
    DependsOn:
      - VaultRootTokenEncryptionKey
    Properties:
      AliasName: !Sub 'alias/${AWS::StackName}/${VaultRootTokenParameterSuffix}'
      TargetKeyId: !Ref VaultRootTokenEncryptionKey

  VaultRootTokenEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy: 
        Version: '2012-10-17'
        Statement: 
          - Effect: "Allow"
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:* # see http://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-default-allow-root-enable-iam
            Resource: "*"

  VaultRootTokenParameterReaderPolicy:
    Type: AWS::IAM::ManagedPolicy
    DependsOn:
      - VaultRootTokenEncryptionKey
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - ssm:GetParameter*
            Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${VaultRootTokenParameterSuffix}'
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
            Resource: !GetAtt VaultRootTokenEncryptionKey.Arn

  VaultRootTokenParameterWriterPolicy:
    Type: AWS::IAM::ManagedPolicy
    DependsOn:
      - VaultRootTokenEncryptionKey
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - ssm:PutParameter*
            Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${VaultRootTokenParameterSuffix}'
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !GetAtt VaultRootTokenEncryptionKey.Arn

  VaultSecretShareEncryptionAlias:
    Type: AWS::KMS::Alias
    DependsOn:
      - VaultSecretShareEncryptionKey
    Properties:
      AliasName: !Sub 'alias/${AWS::StackName}/${VaultSecretShareParameterSuffix}'
      TargetKeyId: !Ref VaultSecretShareEncryptionKey

  VaultSecretShareEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy: 
        Version: '2012-10-17'
        Statement: 
          - Effect: "Allow"
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:* # see http://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-default-allow-root-enable-iam
            Resource: "*"

  VaultSecretShareParameterReaderPolicy:
    Type: AWS::IAM::ManagedPolicy
    DependsOn:
      - VaultSecretShareEncryptionKey
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - ssm:GetParameter*
            Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${VaultSecretShareParameterSuffix}'
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
            Resource: !GetAtt VaultSecretShareEncryptionKey.Arn

  VaultSecretShareParameterWriterPolicy:
    Type: AWS::IAM::ManagedPolicy
    DependsOn:
      - VaultSecretShareEncryptionKey
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - ssm:PutParameter*
            Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${VaultSecretShareParameterSuffix}'
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !GetAtt VaultSecretShareEncryptionKey.Arn

  VaultTransitTokenEncryptionAlias:
    Type: AWS::KMS::Alias
    DependsOn:
      - VaultTransitTokenEncryptionKey
    Properties:
      AliasName: !Sub 'alias/${AWS::StackName}/${VaultTransitTokenParameterSuffix}'
      TargetKeyId: !Ref VaultTransitTokenEncryptionKey

  VaultTransitTokenEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy: 
        Version: '2012-10-17'
        Statement: 
          - Effect: "Allow"
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:* # see http://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-default-allow-root-enable-iam
            Resource: "*"

  VaultTransitTokenParameterReaderPolicy:
    Type: AWS::IAM::ManagedPolicy
    DependsOn:
      - VaultTransitTokenEncryptionKey
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - ssm:GetParameter*
            Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${VaultTransitTokenParameterSuffix}'
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
            Resource: !GetAtt VaultTransitTokenEncryptionKey.Arn

  VaultTransitTokenParameterWriterPolicy:
    Type: AWS::IAM::ManagedPolicy
    DependsOn:
      - VaultTransitTokenEncryptionKey
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - ssm:PutParameter*
            Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${VaultTransitTokenParameterSuffix}'
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !GetAtt VaultTransitTokenEncryptionKey.Arn

  VaultResourcePolicy:
    Type: AWS::IAM::Policy
    DependsOn:
      - VaultResourceRole
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - autoscaling:Describe*
              - ec2:Describe*
              - ssm:DescribeParameters
            Resource: '*'
      PolicyName: !Ref VaultResourceRole
      Roles:
        - !Ref VaultResourceRole

  VaultResourceRole:
    Type: AWS::IAM::Role
    DependsOn:
      - VaultRootTokenParameterReaderPolicy
      - VaultRootTokenParameterWriterPolicy
      - VaultSecretShareParameterWriterPolicy
      - VaultTransitTokenParameterReaderPolicy
      - VaultTransitTokenParameterWriterPolicy
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
            - sts:AssumeRole
          Principal:
            Service:
              - !Sub 'lambda.${AWS::URLSuffix}'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref VaultRootTokenParameterReaderPolicy
        - !Ref VaultRootTokenParameterWriterPolicy
        - !Ref VaultSecretShareParameterWriterPolicy
        - !Ref VaultTransitTokenParameterReaderPolicy
        - !Ref VaultTransitTokenParameterWriterPolicy

  VaultResourceGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enables remote access from DevOps VPC
      VpcId: !Ref Vpc
      SecurityGroupEgress:
        # Allows Rancher OS to pull vault image
        - CidrIp: 0.0.0.0/0
          FromPort: '80'
          ToPort: '80'
          IpProtocol: tcp
        # Allows Rancher OS to pull vault image
        - CidrIp: 0.0.0.0/0
          FromPort: '443'
          ToPort: '443'
          IpProtocol: tcp
        - CidrIp: !GetAtt Vpc.CidrBlock
          FromPort: !Ref VaultPort
          ToPort: !Ref VaultPort
          IpProtocol: tcp
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-VaultResourceGroup'
        - Key: Environment
          Value: !Ref 'AWS::StackName'
  
  VaultResourceFunction:
    Type: AWS::Lambda::Function
    DependsOn:
      - RouteToInternetFromPublic
      - RouteToInternetViaNatFromPrivate1
      - PublicAssociation1
      - PrivateAssociation1
      - PrivateAssociation2
      - PrivateAssociation3
      - VaultResourcePolicy
      - VaultResourceRole
    Properties:
      # CodeUri: vault-test.zip
      Code:
        S3Bucket: !Ref VaultPackageBucket
        S3Key: go-vault-resource.zip
      Environment:
        Variables:
          'VAULT_ADDR': !Sub '${VaultScheme}://${VaultInternalLoadBalancer.DNSName}:${VaultPort}'
          'VAULT_CLIENT_TIMEOUT': '55s'
          'VAULT_MAX_RETRIES': '5'
          'VAULT_TLS_SERVER_NAME': !Sub '${VaultInternalName}.${InternalDomain}'
          'VAULT_TOKEN_PARAMETER': !Sub '/${AWS::StackName}/${VaultRootTokenParameterSuffix}'
          'VAULT_SKIP_VERIFY': 1
      Handler: handler.Handle
      Role: !GetAtt VaultResourceRole.Arn
      Runtime: python2.7
      Timeout: 60 #seconds
      VpcConfig:
        SecurityGroupIds:
          - !Ref VaultResourceGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
          - !Ref PrivateSubnet3

  VaultInitialization:
    Type: Custom::VaultInit
    DependsOn:
      - VaultAutoscalingGroup
      - VaultResourceFunction
    Properties:
      ServiceToken: !GetAtt VaultResourceFunction.Arn
      ServerScheme: !Ref VaultScheme
      ServerGroup: !Ref VaultAutoscalingGroup
      ServerPort: !Ref VaultPort
      ShouldUnseal: 'true'
      RootTokenEncryptionKey: !Ref VaultRootTokenEncryptionAlias
      RootTokenParameterName: !Sub '/${AWS::StackName}/${VaultRootTokenParameterSuffix}'
      SecretShareEncryptionKey: !Ref VaultSecretShareEncryptionAlias
      SecretShareParameterName: !Sub '/${AWS::StackName}/${VaultSecretShareParameterSuffix}'

  VaultAuditLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 90

  VaultAuditConfiguration:
    Type: Custom::VaultAudit
    DependsOn:
      - VaultAuditLogGroup
      - VaultInitialization
      - VaultInternalAlias
      - VaultRootTokenEncryptionAlias
    Properties:
      ServiceToken: !GetAtt VaultResourceFunction.Arn
      Type: file
      Description: /vault/logs/audit.log
      Options:
        file_path: /vault/logs/audit.log
      Disable: false

  VaultAuthTokenConfig:
    Type: Custom::VaultMount
    DependsOn:
      - VaultInitialization
      - VaultInternalAlias
      - VaultRootTokenEncryptionAlias
    Properties:
      ServiceToken: !GetAtt VaultResourceFunction.Arn
      Path: auth/token
      DefaultLeaseTTL: 720h
      MaximumLeaseTTL: 8760h
      TuneOnly: 'true'

  VaultTransitMount:
    Type: Custom::VaultMount
    DependsOn:
      - VaultInitialization
      - VaultInternalAlias
      - VaultRootTokenEncryptionAlias
    Properties:
      ServiceToken: !GetAtt VaultResourceFunction.Arn
      Type: transit
      Description: encryption as a service

  VaultTransitKey:
    Type: Custom::VaultLogical
    DependsOn:
      - VaultTransitMount
    Properties:
      ServiceToken: !GetAtt VaultResourceFunction.Arn
      Path: !Sub '${VaultTransitMount.Path}keys/${VaultTransitKeyName}'

  VaultTransitPolicy:
    Type: Custom::VaultPolicy
    DependsOn:
      - VaultTransitMount
    Properties:
      ServiceToken: !GetAtt VaultResourceFunction.Arn
      Name: !Sub '${VaultTransitKeyName}-transit'
      Rules:
        Fn::Sub: |
          path "${VaultTransitMount.Path}random/*" {
            capabilities = ["create", "update"]
          }
          path "${VaultTransitMount.Path}hmac/*" {
            capabilities = ["create", "update"]
          }
          path "${VaultTransitMount.Path}encrypt/${VaultTransitKeyName}" {
            capabilities = ["create", "update"]
          }
          path "${VaultTransitMount.Path}decrypt/${VaultTransitKeyName}" {
            capabilities = ["create", "update"]
          }
          path "${VaultTransitMount.Path}verify/${VaultTransitKeyName}/*" {
            capabilities = ["create", "update", "read"]
          }
          path "${VaultTransitMount.Path}keys/*" {
            capabilities = ["deny"]
          }
          path "sys/*" {
            capabilities = ["deny"]
          }
          path "auth/token/*" {
            capabilities = ["create", "read", "update", "delete", "list"]
          }

  VaultTransitToken:
    Type: Custom::VaultToken
    DependsOn:
      - VaultAuthTokenConfig
      - VaultTransitKey
      - VaultTransitPolicy
      - VaultTransitTokenEncryptionAlias
      - VaultTransitTokenParameterReaderPolicy
      - VaultTransitTokenParameterWriterPolicy
    Properties:
      ServiceToken: !GetAtt VaultResourceFunction.Arn
      ParameterDescription: Vault Transit Token
      ParameterName: !Sub '/${AWS::StackName}/${VaultTransitTokenParameterSuffix}'
      ParameterKey: !Ref VaultTransitTokenEncryptionAlias
      Policies:
        - !GetAtt VaultTransitPolicy.Name
# Resources ###################################################################
